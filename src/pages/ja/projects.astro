---
import { getCollection } from 'astro:content';
import TerminalLayout from '../../layouts/TerminalLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { getTranslations } from '../../i18n/utils';

const lang = 'ja';
const t = getTranslations(lang);
const currentPath = Astro.url.pathname;

// Parse period string to get start date for sorting (Japanese format: "2022年9月")
function getStartDate(period: string): Date {
  if (!period) return new Date(0);

  // Extract the start part (before the dash)
  const startPart = period.split('-')[0].trim();

  // Parse Japanese format: "2022年9月"
  const jaMatch = startPart.match(/(\d{4})年(\d{1,2})月/);
  if (jaMatch) {
    const year = parseInt(jaMatch[1]);
    const month = parseInt(jaMatch[2]) - 1; // JS months are 0-indexed
    return new Date(year, month);
  }

  return new Date(0);
}

const projectEntries = await getCollection('projects', ({ id }) => id.startsWith('ja/'));
const sortedProjects = projectEntries.sort((a, b) => {
  const dateA = getStartDate(a.data.period || '');
  const dateB = getStartDate(b.data.period || '');
  return dateB.getTime() - dateA.getTime(); // Newest first
});
---

<TerminalLayout
  title={t.pages.projects.title}
  description={t.meta.description}
  lang={lang}
  currentPath={currentPath}
>
  <section class="projects-content">
    <div class="prompt">{t.pages.projects.prompt}</div>
    <div class="timeline">
      {sortedProjects.map(async (project) => {
        const { Content } = await project.render();
        return (
          <ProjectCard
            title={project.data.title}
            description={project.data.description}
            techStack={project.data.techStack}
            role={project.data.role}
            period={project.data.period}
            githubUrl={project.data.githubUrl}
            liveUrl={project.data.liveUrl}
          >
            <Content />
          </ProjectCard>
        );
      })}
    </div>
    <div class="cursor">$ <span class="blink">_</span></div>
  </section>
</TerminalLayout>

<style>
  .projects-content {
    max-width: 800px;
  }

  .prompt {
    color: var(--accent-secondary);
    margin-bottom: 1.5rem;
  }

  .timeline {
    margin-bottom: 2rem;
  }

  .cursor {
    color: var(--text-primary);
  }

  .blink {
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }
</style>
